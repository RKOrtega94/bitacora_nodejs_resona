extends layout

block content
    // Page Wrapper
    #wrapper
        include helpers/sidebar
        // Content Wrapper
        #content-wrapper.d-flex.flex-column
            // Main Content
            #content
                include helpers/topbar
                // Begin Page Content
                .container-fluid
                    #loading.container.text-center
                    .d-sm-flex.align-items-center.justify-content-between.mb-4
                        h6#promedioTmo.mb-0.text-info
                        h6#cumplimientoTmo
                    // DataTales Example
                    .card.shadow.mb-4
                        .card-header.py-3
                            h6.m-0.font-weight-bold.text-primary Registro general
                        .card-body
                            .table-responsive
                                table#dataTable.table.table-bordered(width='100%' cellspacing='0')
                                    thead
                                        tr
                                            th Fecha
                                            th Anillamador
                                            th Identification
                                            th PIR
                                            th Ticket
                                            th Time
                                    tfoot
                                        tr
                                            th Fecha
                                            th Anillamador
                                            th Identification
                                            th PIR
                                            th Ticket
                                            th Time
                                    tbody
                // End of Main Content
                // Footer
                br
                footer.sticky-footer.bg-white
                    .container.my-auto
                        .copyright.text-center.my-auto
                            span Copyright Â© RESONATELECOM S.A. 2019
                    br
                    .container.my-auto
                        .copyright.text-center.my-auto
                            span Developed by Robinson Ortega
                // End of Footer
                // End of Content Wrapper
                // End of Page Wrapper
                // Scroll to Top Button
                a.scroll-to-top.rounded(href='#page-top')
                    i.fas.fa-angle-up
                include helpers/logout
    //JQuery
    script(src='/vendor/jquery/jquery.min.js')
    // Data table Scripts
    script(src='/vendor/datatables/jquery.dataTables.min.js')
    script(src='/javascripts/demo/datatables-demo.js')
    // The core Firebase JS SDK is always required and must be listed first
    script(src='https://www.gstatic.com/firebasejs/6.6.2/firebase-app.js')
    // Add Firebase products that you want to use
    script(src='https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js')
    script.
        //Define variables
        var user = "!{result}";
        var result = [];
        //Firebase Config
        var firebaseConfig = {
        apiKey: "AIzaSyBe7C2-8lUMP1KWPJ_-lkvKzu0ytl5fAME",
        authDomain: "resonatel.firebaseapp.com",
        databaseURL: "https://resonatel.firebaseio.com",
        projectId: "resonatel",
        storageBucket: "resonatel.appspot.com",
        messagingSenderId: "710009860039",
        appId: "1:710009860039:web:54d43ee0d8b8a4733ab3e2"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // Get reference
        var query = firebase.database().ref("tickets/"+user)
        var count = 0
        var minutes = 0
        var seconds = 0
        var duration = 0
        var tmo = 0
        function addRow(data){
            var table = $('#dataTable').DataTable();
            var date = new Date;
            var month = '' + (date.getMonth()+1)
            if (month.length <= 1) {
            month = '0' + month;
            }
            today = month + '/' + date.getFullYear()
            if(today == data.date.substr(3, 7)){
                minutes = minutes + parseInt(data.tmo.substr(0, 2), 10)
                seconds = seconds + parseInt(data.tmo.substr(3, 4), 10)
                duration = (seconds*1000) + (minutes*60000)
                count++
                tmo = duration/count
                var mm = parseInt((tmo/(1000*60))) < 10 ? '0' + parseInt((tmo/(1000*60))) : parseInt((tmo/(1000*60)))
                var ss = parseInt((tmo/1000)%60) < 10 ? '0' + parseInt((tmo/1000)%60) : parseInt((tmo/1000)%60)
                var promedioTmo = 'Promedio TMO mensual: ' + mm + ':' + ss
                var porcentaje = parseInt(mm)*60 + parseFloat('0.'+ss)*60
                if(porcentaje >= (451) && porcentaje <= (495)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-success strong\">TMO: 100%</p>"
                } else if(porcentaje >= (406) && porcentaje <= (450)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-warning strong\">TMO: 80%</p>"
                } else if (porcentaje >= (496) && porcentaje <= (540)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-warning strong\">TMO: 80%</p>"
                } else if(porcentaje >= (586)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-danger strong\">TMO: 0%</p>"
                } else if(porcentaje >= 0 && porcentaje <= (360)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-danger strong\">TMO: 0%</p>"
                } else if(porcentaje >= (361) && porcentaje <= (405)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-secondary strong\">TMO: 60%</p>"
                } else if(porcentaje >= (541) && porcentaje <= (585)){
                    document.getElementById("cumplimientoTmo").innerHTML = "<p class=\"text-secondary strong\">TMO: 60%</p>"
                }
            }
            document.getElementById("promedioTmo").innerHTML = promedioTmo
            table.row.add([
                data.date,
                data.anillamador,
                data.dni,
                data.pir,
                data.ticket,
                data.tmo
            ]).draw(true);
        }
        document.getElementById("loading").innerHTML = "<div class=\"spinner-border text-success\" role=\"status\"><span class=\"sr-only\">Loading...</span></div>"
        // Query database
        query.once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
        result = childSnapshot.val()
            addRow(result)
            setTimeout(function(){
                document.getElementById("loading").remove()
            }, 500);
        })
        })